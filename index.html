<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expense Tracker</title>
  <style>
    /* ---------- style.css (inlined) ---------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }

    html, body { height: 100%; }
    body {
      font-family: "Poppins", sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }

    .card {
      background: #fff;
      padding: 22px;
      border-radius: 14px;
      box-shadow: 0 8px 30px rgba(15, 30, 60, 0.08);
      width: 360px;
      max-width: calc(100% - 40px);
    }

    h1 { text-align: center; color: #1565c0; margin-bottom: 10px; }
    h3 { margin-bottom: 10px; }

    .balance { text-align: center; margin: 14px 0; }

    .summary { display: flex; justify-content: space-between; gap: 12px; margin-bottom: 14px; }
    .income p { color: green; font-weight: 700; margin-top: 6px; }
    .expense p { color: red; font-weight: 700; margin-top: 6px; text-align: right; }

    input[type="text"], input[type="password"], input[type="number"] {
      width: 100%;
      padding: 12px 14px;
      margin-top: 8px;
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.08);
      background-color: #f1f3f8;
      outline: none;
      font-size: 14px;
    }

    input:focus { box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.08); border-color: rgba(25,118,210,0.28); }

    .input { display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 12px; }

    button {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    button.primary {
      background: #1976d2;
      color: #fff;
      width: 100%;
      margin-top: 10px;
    }
    button.primary:hover { background: #0d47a1; }

    .logout {
      width: 100%;
      margin-top: 12px;
      background: crimson;
      color: #fff;
    }
    .logout:hover { background: darkred; }

    ul { list-style: none; padding: 0; margin-top: 10px; max-height: 260px; overflow: auto; }
    li {
      background: #f7f7f7;
      margin-top: 10px;
      padding: 10px;
      border-left: 5px solid;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      border-radius: 8px;
    }
    li.income { border-color: green; }
    li.expense { border-color: red; }

    .desc { flex: 1; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 8px; }
    .amount { min-width: 80px; text-align: right; font-weight: 600; }

    .action-btns { display: flex; gap: 8px; align-items: center; }
    .delete-btn, .edit-btn { background: transparent; border: none; cursor: pointer; font-weight: 700; padding: 4px 6px; }
    .delete-btn { color: crimson; }
    .edit-btn { color: #e31111; }

    .auth-container { text-align: center; }
    #toggleAuth { margin-top: 10px; font-size: 14px; color: rgba(0,0,0,0.7); }
    #toggleAuth span { color: #1976d2; cursor: pointer; text-decoration: underline; }

    @media (max-width: 420px) {
      .card { width: 100%; padding: 16px; border-radius: 12px; }
      .amount { min-width: 70px; }
    }
  </style>
</head>
<body>
  <!-- Authentication Section -->
  <div id="authSection" class="card auth-container">
    <h1>ðŸ’° Expense Tracker</h1>
    <div id="authBox">
      <h3 id="authTitle">Login</h3>
      <input type="text" id="username" placeholder="Email (use real email)" autocomplete="username" />
      <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
      <button id="authBtn" class="primary">Login</button>
      <p id="toggleAuth">Don't have an account? <span id="toggleLink">Sign Up</span></p>
    </div>
  </div>

  <!-- Expense Tracker App -->
  <div class="container card" id="appSection" style="display:none;">
    <h1>ðŸ’° Expense Tracker</h1>

    <div class="balance">
      <h2>Your Balance</h2>
      <h3 id="balance">à§³0</h3>
    </div>

    <div class="summary">
      <div class="income">
        <h4>Income</h4>
        <p id="income">à§³0</p>
      </div>
      <div class="expense">
        <h4>Expense</h4>
        <p id="expense">à§³0</p>
      </div>
    </div>

    <div class="input">
      <h3>Add Transaction</h3>
      <input type="text" id="descInput" placeholder="Enter Description..." />
      <input type="number" id="amountInput" placeholder="Enter Amount [use Minus(-) for Expense]" />
      <button id="addBtn" class="primary">Add</button>
    </div>

    <h3>History</h3>
    <ul id="transactionList"></ul>

    <button id="logoutBtn" class="logout">Logout</button>
  </div>

  <!-- =========================
       Original Expense Tracker JS (kept logic intact)
       This runs first (not a module).
       ========================= -->
  <script>
  // =========================
  // Original Expense Tracker
  // (kept logic intact)
  // =========================
  // Use a global transactions var so firebase module can access/replace it later
  window.transactions = JSON.parse(localStorage.getItem('transactions')) || []

  const descInput = document.getElementById('descInput')
  const amountInput = document.getElementById('amountInput')
  const addBtn = document.getElementById('addBtn')
  const transactionList = document.getElementById('transactionList')
  const balanceEl = document.getElementById('balance')
  const incomeEl = document.getElementById('income')
  const expenseEl = document.getElementById('expense')

  function updateUI() {
      transactionList.innerHTML = ''
      let income = 0
      let expense = 0

      window.transactions.forEach((t, index) => {
          const li = document.createElement('li')
          li.classList.add(t.amount > 0 ? 'income' : 'expense')
          li.innerHTML =
          `
              <span class="desc">${t.desc}</span>
              <span class="amount">à§³${t.amount}</span>
              <div class="action-btns">
                  <button class="edit-btn" onclick="editTransaction(${index})">âœŽ</button>
                  <button class="delete-btn" onclick="deleteTransaction(${index})">X</button>
              </div>
          `

          transactionList.appendChild(li)

          if (t.amount > 0) income += t.amount
          else expense += t.amount
      })

      const balance = income + expense
      balanceEl.textContent = `à§³${(balance).toFixed(2)}`
      incomeEl.textContent = `à§³${(income).toFixed(2)}`
      expenseEl.textContent = `à§³${Math.abs(expense).toFixed(2)}`

      localStorage.setItem('transactions', JSON.stringify(window.transactions))

      if (balance > 0) {
          balanceEl.style.color = "green"
      } else if (balance < 0) {
          balanceEl.style.color = "red"
      } else {
          balanceEl.style.color = "#01040aff"
      }
  }

  addBtn.addEventListener('click', () => {
      const desc = descInput.value.trim()
      const amount = parseFloat(amountInput.value.trim())

      if (!desc || isNaN(amount)) return

      window.transactions.push({ desc, amount })
      descInput.value = ''
      amountInput.value = ''
      updateUI()
  })

  function deleteTransaction(index) {
      window.transactions.splice(index, 1)
      updateUI()
  }

  function editTransaction(index) {
      const newDesc = prompt("Edit Description:", window.transactions[index].desc)
      const newAmount = prompt("Edit Amount:", window.transactions[index].amount)

      if (newDesc === null || newAmount === null) return
      if (newDesc.trim() === "" || isNaN(parseFloat(newAmount))) {
          alert("Invalid input")
          return
      }

      window.transactions[index].desc = newDesc.trim()
      window.transactions[index].amount = parseFloat(newAmount)

      updateUI()
  }

  updateUI()
  </script>

  <!-- =========================
       Firebase module (must load after original script)
       ========================= -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      onSnapshot,
      setDoc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCSSwkgrigkZfau6uTJF-6j5ECepCisR7I",
      authDomain: "earn-cost-count.firebaseapp.com",
      projectId: "earn-cost-count",
      storageBucket: "earn-cost-count.firebasestorage.app",
      messagingSenderId: "318934337712",
      appId: "1:318934337712:web:b69a340ffd1bde45705375",
      measurementId: "G-73QX436ZEQ"
    };

    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch(e){ /* ignore analytics errors */ }
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM refs (same IDs)
    const authSection = document.getElementById('authSection');
    const appSection = document.getElementById('appSection');
    const authTitle = document.getElementById('authTitle');
    const authBtn = document.getElementById('authBtn');
    const toggleAuth = document.getElementById('toggleAuth');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const logoutBtn = document.getElementById('logoutBtn');

    let isLoginMode = true;
    let userDocUnsub = null;
    let originalUpdateUI = window.updateUI; // keep reference to original

    // Toggle login/signup (same UI)
    toggleAuth.addEventListener('click', (e) => {
      if (e.target && e.target.id === 'toggleLink') {
        isLoginMode = !isLoginMode;
        authTitle.textContent = isLoginMode ? 'Login' : 'Sign Up';
        authBtn.textContent = isLoginMode ? 'Login' : 'Sign Up';
        toggleAuth.innerHTML = isLoginMode
          ? `Don't have an account? <span id="toggleLink">Sign Up</span>`
          : `Already have an account? <span id="toggleLink">Login</span>`;
      }
    });

    // Auth button: signup or login with Firebase
    authBtn.addEventListener('click', async () => {
      const email = usernameInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        alert('Please fill all fields.');
        return;
      }

      try {
        if (isLoginMode) {
          await signInWithEmailAndPassword(auth, email, password);
        } else {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          // create user doc if not exists
          const ud = doc(db, 'users', cred.user.uid);
          await setDoc(ud, { transactions: [] }, { merge: true });
          alert('Signup successful!');
        }

        usernameInput.value = '';
        passwordInput.value = '';
      } catch (err) {
        alert(err.message);
      }
    });

    // Function: attach Firestore realtime listener & override updateUI to save
    function attachUserSync(user) {
      const userDocRef = doc(db, 'users', user.uid);

      // Unsubscribe previous if exists
      if (userDocUnsub) { userDocUnsub(); userDocUnsub = null; }

      // On remote changes -> overwrite local transactions and update UI
      userDocUnsub = onSnapshot(userDocRef, (snap) => {
        if (snap.exists()) {
          const data = snap.data();
          // Replace local array without breaking reference
          window.transactions = data.transactions || [];
        } else {
          window.transactions = [];
        }
        // ensure localStorage also updated by calling originalUpdateUI
        originalUpdateUI();
      }, (err) => {
        console.error('onSnapshot error', err);
      });

      // Monkey-patch updateUI to save to Firestore after running original UI logic
      window.updateUI = function () {
        originalUpdateUI();
        // save to Firestore (store under users/{uid}.transactions)
        setDoc(userDocRef, { transactions: window.transactions }).catch(err => {
          console.error('Failed to save transactions to Firestore:', err);
        });
      };
    }

    // Detach and restore original updateUI (used on logout)
    function detachUserSync() {
      if (userDocUnsub) { userDocUnsub(); userDocUnsub = null; }
      window.updateUI = originalUpdateUI;
    }

    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // show app
        authSection.style.display = 'none';
        appSection.style.display = 'block';

        // ensure user doc exists and load initial data
        const userDocRef = doc(db, 'users', user.uid);
        try {
          const docSnap = await getDoc(userDocRef);
          if (docSnap.exists()) {
            window.transactions = docSnap.data().transactions || [];
            originalUpdateUI();
          } else {
            // create empty
            await setDoc(userDocRef, { transactions: window.transactions || [] });
          }
        } catch (err) {
          console.error('Error reading/creating user doc:', err);
        }

        // attach realtime sync + override updateUI
        attachUserSync(user);
      } else {
        // logged out -> show auth, detach firestore sync
        detachUserSync();
        authSection.style.display = 'block';
        appSection.style.display = 'none';
        // keep using localStorage transactions (already set)
        window.transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        originalUpdateUI();
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        console.error('signout err', err);
      }
    });
  </script>
</body>
</html>
